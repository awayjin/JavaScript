<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>Title</title>
</head>
<body>
<div id="id"> id </div>

<script>
  document.documentElement.onclick = function () {
    console.log('publish-subscribe')
  }

  // 订阅
  document.documentElement.addEventListener('click', function () {
    console.log('发布-订阅')
  }, false)


  var dom = document.querySelector('#id')
  // 自定义事件
  // var event = new Event('build')
  var event = new CustomEvent('build', {
    detail: '自定义数据1'
  })

  // Listen for the event.
  dom.addEventListener('build', function (e) {
    console.log('custom events>.....', e.detail)
    console.log(e)
  }, false);

  // Dispatch the event.
  dom.dispatchEvent(event);

  // 最简单模式
  void function () {
    // 发布-订阅模式
    // 发布者-售楼处
    var salesOffices = {
      clientList: [], // 缓存列表，存放订阅者的回调函数
      listen (fn) { // 增加订阅者
        this.clientList.push(fn) // 订阅的消息添加进缓存列表
      },
      trigger () { // 发布消息
        for(let i = 0, fn; fn = this.clientList[i++];) {
          fn.apply(this, arguments)
        }
      }
    }

    // 订阅消息
    salesOffices.listen(function (price, squareMeter) {
      console.log('price:', price)
      console.log('squareMeter:', squareMeter)
    })

    salesOffices.listen(function (price, squareMeter) {
      console.log('price3:', price)
      console.log('squareMeter3:', squareMeter)
    })

    salesOffices.trigger(2000, '88')
    salesOffices.trigger(3000, '120')
  }()

  console.log(Array(20).join('-'), '增加一个标识 key, 只订阅自己感兴趣的消息', Array(20).join('-'))

  // 增加一个标识 key, 只订阅自己感兴趣的消息
  void function () {
    // 定义售楼处充当发布者
    let salesOffices = {
      // 缓存列表
      clientList: [],

      // 增加订阅者
      listen (key, fn) {
        // 如果还没有订阅过此类消息，给该类消息创建一个缓存列表
        if (!this.clientList[key]) {
          this.clientList[key] = []
        }
        // 订阅的消息添加进缓存列表
        this.clientList[key].push(fn)
      },

      // 发布消息
      trigger () {
        // 取出消息类型
        let key = Array.prototype.shift.call(arguments)
        // 取出消息对应的回调函数
        let fns = this.clientList[key]

        // 如果没有订阅消息则返回
        if (!fns || fns.length === 0) {
          return false
        }

        // 执行
        for (let i = 0, fn; fn = fns[i++];) {
          fn.apply(this, arguments)
        }
      }
    } // close salesOffices

    // 订阅88平
    salesOffices.listen('squareMeter88', (price) => {
      console.log('price=', price)
    })

    // 订阅 122 平
    salesOffices.listen('squareMeter122', (price) => {
      console.log('price=2', price)
    })

    // 订阅88平
    salesOffices.listen('squareMeter88', (price) => {
      console.log('price3=', price)
    })

    salesOffices.trigger('squareMeter88', 500) // 发布88平500的消息
    salesOffices.trigger('a33', 500) // 发布88平500的消息, 没有订阅
    salesOffices.trigger('squareMeter122', 1500) // 发布 122 平 1500 的消息

  }()

  console.log(Array(20).join('-'), '观察者模式通用实现', Array(20).join('-'))

  // 发布-订阅模式通用实现
  var event = {
  }

  // 给所有对象动态安装发布-订阅功能
  var installEvent = function (obj) {
    for (var i in event) {
      obj[i] = event[i]
    }
  }


</script>

</body>
</html>